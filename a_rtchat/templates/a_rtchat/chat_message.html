{% comment %}
Message template (sender / receiver). Place this inside your loop where `message` and `user` are defined.
{% endcomment %}

{% if message.author == user %}
<li
  id="message-{{ message.id }}"
  class="flex justify-end mb-3 group"
  hx-swap-oob="outerHTML:#message-{{ message.id }}"
  data-message-id="{{ message.id }}"
  data-own="1"
>
  <div class="bubble bg-indigo-600 text-white rounded-l-2xl rounded-tr-2xl p-3 pr-9 max-w-[75%] shadow relative">
    {% if not message.is_deleted %}
    <div
      id="msg-menu-{{ message.id }}"
      class="hidden absolute -top-2 right-0 translate-y-[-110%] mt-2 bg-black/80 backdrop-blur text-white text-xs rounded-md shadow-lg p-2 min-w-[160px]"
    >
      <div class="flex flex-col gap-1.5">
        <button
          type="button"
          class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
          data-action="open-edit"
        >
          Edit
        </button>
        <div class="h-px bg-white/10"></div>
        <button
          type="button"
          class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
          data-action="toggle-select"
        >
          Select
        </button>
        <div class="h-px bg-white/10"></div>
        <button
          type="button"
          class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
          data-action="open-delete"
        >
          Delete
        </button>
      </div>
    </div>

    <div
      id="msg-delconf-{{ message.id }}"
      class="hidden absolute -top-2 right-0 translate-y-[-110%] mt-2 bg-gray-900 text-white text-sm rounded-lg shadow-xl p-4 max-w-[320px]"
    >
      <div class="mb-2">Are you sure you want to delete this message?</div>
      <div class="flex items-center gap-4">
        <form hx-post="{% url 'message-delete' message.id %}" hx-swap="none" method="post">
          {% csrf_token %}
          <button
            type="submit"
            class="px-4 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-white"
          >
            Delete
          </button>
        </form>

        <button
          type="button"
          class="px-4 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-white"
          data-action="close-delete"
        >
          Cancel
        </button>
      </div>
    </div>
    {% endif %}

    {% if message.is_deleted %}
      <span class="italic text-white/80">This message has been deleted</span>
      <span class="not-italic"> ⊘</span>
    {% else %}
      <span class="whitespace-pre-wrap break-words">{{ message.body }}</span>
      {% if message.edited %}
        <span class="ml-2 text-xs opacity-80">(edited)</span>
      {% endif %}
    {% endif %}
    <span class="absolute bottom-1 right-2 text-[11px] leading-none select-none">
      {% if message.status == 0 %}
        <span style="color:#9e9e9e; opacity:.85">✓</span>
      {% elif message.status == 1 %}
        <span style="color:#555555">✓✓</span>
      {% else %}
        <span style="color:#b103e6">✓✓</span>
      {% endif %}
    </span>
  </div>

  <div class="flex items-end">
    <svg height="13" width="8" viewBox="0 0 10 13" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path fill="#4f46e5" d="M6.3,10.4C1.5,8.7,0.9,5.5,0,0.2L0,13l5.2,0C7,13,9.6,11.5,6.3,10.4z"/>
    </svg>
  </div>
</li>

{% if not message.is_deleted %}
<!-- Per-message inline JS removed; handled by a single delegated script in chat.html -->
{% endif %}

{% else %}
<li id="message-{{ message.id }}" hx-swap-oob="outerHTML:#message-{{ message.id }}">
  <div class="flex justify-start mb-3">
    <div class="flex items-end mr-2">
      <a href="{% url 'profile' message.author.username %}">
        <img class="w-8 h-8 rounded-full object-cover" src="{{ message.author.profile.avatar }}" alt="{{ message.author.username }}'s avatar">
      </a>
    </div>

    <div class="flex items-end">
      <svg height="13" width="8" viewBox="0 0 10 13" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path fill="#1f2937" d="M2.8,13L8,13L8,0.2C7.1,5.5,6.5,8.7,1.7,10.4C-1.6,11.5,1,13,2.8,13z"/>
      </svg>
    </div>

    <div class="bubble bg-gray-800 text-gray-100 p-3 max-w-[75%] rounded-r-2xl rounded-tl-2xl shadow">
      {% if message.is_deleted %}
        <span class="italic text-gray-400">This message has been deleted</span>
        <span class="not-italic text-gray-400"> ⊘</span>
      {% else %}
        <span class="whitespace-pre-wrap break-words">{{ message.body }}</span>
        {% if message.edited %}
          <span class="ml-2 text-xs text-gray-400">(edited)</span>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="text-xs font-light py-1 ml-10 text-gray-400">
    <span class="text-gray-300">{{ message.author.profile.name }}</span>
    <span class="text-gray-500">@{{ message.author.username }}</span>
  </div>
</li>
{% endif %}