{% load static %}
{% static 'images/avatar.svg' as default_avatar %}

<li id="message-{{ message.id }}" class="mb-2 group"
    hx-swap-oob="outerHTML:#message-{{ message.id }}"
    data-message-id="{{ message.id }}"
    data-own="{% if message.author_id == user.id %}1{% else %}0{% endif %}">

  <div class="flex {% if message.author_id == user.id %}justify-end{% else %}justify-start{% endif %} gap-2">
    {% if message.author_id != user.id and message.show_avatar %}
      <img class="w-9 h-9 rounded-full self-end object-cover"
           src="{{ message.author.profile.avatar|default:default_avatar }}"
           alt="{{ message.author.profile.display_name|default:message.author.username }}"
           onerror="this.onerror=null;this.src='{{ default_avatar }}'">
    {% endif %}

    <div class="max-w-[75%]">
      <div class="relative bubble rounded-2xl px-3 py-2
                  {% if message.author_id == user.id %}bg-indigo-600 text-white{% else %}bg-gray-800 text-gray-100{% endif %}">

        {# --- OWN MESSAGE CONTEXT MENU + DELETE CONFIRM (for right click) --- #}
        {% if message.author_id == user.id and not message.is_deleted %}
          <div
            id="msg-menu-{{ message.id }}"
            class="hidden absolute -top-2 right-0 translate-y-[-110%] mt-2
                   bg-black/80 backdrop-blur text-white text-xs rounded-md
                   shadow-lg p-2 min-w-[160px] z-20"
          >
            <div class="flex flex-col gap-1.5">
              <button
                type="button"
                class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
                data-action="open-edit"
                data-edit-url="{% url 'message-edit' message.id %}"
              >
                Edit
              </button>
              <div class="h-px bg-white/10"></div>
              <button
                type="button"
                class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
                data-action="toggle-select">
                Select
              </button>
              <div class="h-px bg-white/10"></div>
              <button
                type="button"
                class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
                data-action="hide-for-me"
                data-hide-url="{% url 'message-hide-me' message.id %}"
              >
                Delete for me
              </button>
              <div class="h-px bg-white/10"></div>
              <button
                type="button"
                class="block w-full text-left px-2 py-1 rounded hover:bg-white/10"
                data-action="open-delete"
              >
                Delete for all
              </button>
            </div>
          </div>

          <div
            id="msg-delconf-{{ message.id }}"
            class="hidden absolute -top-2 right-0 translate-y-[-110%] mt-2
                   bg-gray-900 text-white text-sm rounded-lg shadow-xl p-4
                   max-w-[320px] z-30"
          >
            <div class="mb-2">Delete this message for <strong>everyone</strong>?</div>
            <div class="flex items-center gap-4">
              <form hx-post="{% url 'message-delete' message.id %}"
                    hx-swap="none"
                    method="post">
                {% csrf_token %}
                <button type="submit"
                        class="px-4 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-white">
                  Delete for all
                </button>
              </form>
              <button
                type="button"
                class="px-4 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-white"
                data-action="close-delete"
              >
                Cancel
              </button>
            </div>
          </div>
        {% endif %}
        {# --- END CONTEXT MENU BLOCK --- #}

        {% if message.is_deleted %}
          <span class="italic {% if message.author_id == user.id %}text-white/80{% else %}text-gray-400{% endif %}">
            This message has been deleted ⊘
          </span>
        {% else %}
          <span class="whitespace-pre-wrap break-words">{{ message.body }}</span>
          {% if message.edited %}
            <span class="ml-2 text-xs {% if message.author_id == user.id %}opacity-80{% else %}text-gray-400{% endif %}">
              (edited)
            </span>
          {% endif %}
        {% endif %}

        {% if message.author_id == user.id and not message.is_deleted %}
        <span class="absolute bottom-1 right-2 text-[11px] leading-none select-none">
          {# If the peer has read this message, force blue/purple double tick #}
          {% if message.read_by_peer %}
            <span style="color:#b103e6">✓✓</span>
          {% elif message.status == 0 %}
            {# Sent only #}
            <span style="color:#9e9e9e; opacity:.85">✓</span>
          {% elif message.status == 1 %}
            {# Delivered but not read #}
            <span style="color:#555555">✓✓</span>
          {% else %}
            {# Fallback #}
            <span style="color:#555555">✓✓</span>
          {% endif %}
        </span>
        {% endif %}
      </div>

      {% if message.show_meta and not message.is_deleted %}
        <div class="mt-1 text-[11px] text-gray-400 pl-1 text-right">
          {{ message.author.profile.display_name|default:message.author.username }}
          &middot;
          {{ message.created|date:"M j, H:i" }}
        </div>
      {% endif %}
    </div>
  </div>
</li>
