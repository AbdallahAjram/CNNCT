{% load static %}
{% static 'images/avatar.svg' as default_avatar %}

<aside class="w-[360px] min-w-[320px] max-w-[420px] h-[calc(100vh-56px)] bg-[#0f172a] border-r border-gray-800 flex flex-col">
    <div class="p-3">
        <div class="flex items-center gap-2">
          <div class="relative w-full">
            <input id="chat-search" type="text" placeholder="Search chats"
                   class="w-full rounded-xl pl-10 pr-4 py-2 bg-gray-800 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   oninput="filterChats(this.value)" autocomplete="off">
            <svg viewBox="0 0 24 24" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="currentColor" aria-hidden="true">
              <path d="M10 4a6 6 0 104.472 10.034l3.747 3.747a1 1 0 001.415-1.415l-3.747-3.747A6 6 0 0010 4zm-4 6a4 4 0 118 0 4 4 0 01-8 0z"/>
            </svg>
          </div>
          <!-- Keep only this button -->
          <button type="button"
                  class="shrink-0 px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500"
                  onclick="openNewChat()">New Chat</button>
        </div>
    </div>

    <style>
        #chat-search{
            background-color: #0f172a;
            color: #e5e7eb !important;
            padding-left: 2.5rem !important;
        }
        #chat-search::placeholder{ color:#9ca3af !important; }
    </style>

    {% if archived_only %}
      <div class="flex items-center justify-between px-3 py-2 text-xs uppercase tracking-wider text-gray-400">
        <a href="{% url 'home' %}" class="flex items-center gap-1 hover:text-gray-200">
          ‚Üê Back
        </a>
        <span>Archived chats</span>
      </div>
    {% else %}
      <div class="flex items-center justify-between px-3 py-2 text-xs uppercase tracking-wider text-gray-400">
        <span>Chats</span>
        <a href="{% url 'home' %}?archived=1" class="flex items-center gap-1 text-[11px] text-gray-400 hover:text-gray-200">
          <span class="inline-block w-3 h-3 border border-gray-500 rounded-[3px] relative">
            <span class="absolute left-[2px] top-[2px] right-[2px] bottom-[2px] border-t border-gray-500"></span>
          </span>
          Archived
        </a>
      </div>
    {% endif %}

    <ul id="chat-list" class="overflow-y-auto flex-1 px-2" style="scrollbar-gutter: stable both-edges;">
        {% if not sidebar_chats %}
        <li class="px-3 py-8 text-center text-gray-400">
            <div class="text-sm">No conversations yet. Start a new chat to begin.</div>
        </li>
        {% endif %}

        {% for item in sidebar_chats %}
            {% if item.kind == 'group' %}
                {% with cg=item.group %}
                <li data-name="{{ cg.groupchat_name|lower }}">
                    {% if archived_only %}
                    <a href="{% url 'chatroom' cg.group_name %}?archived=1" class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-800 {% if chat_group and chat_group.group_name == cg.group_name %}bg-gray-800{% endif %}">
                    {% else %}
                    <a href="{% url 'chatroom' cg.group_name %}" class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-800 {% if chat_group and chat_group.group_name == cg.group_name %}bg-gray-800{% endif %}">
                    {% endif %}
                        {% if cg.avatar %}
                          <img
                              class="w-10 h-10 rounded-full object-cover"
                              src="{{ cg.avatar }}"
                              alt="Group"
                              loading="lazy"
                              decoding="async"
                              referrerpolicy="no-referrer"
                              onerror="this.onerror=null;this.src='{{ default_avatar }}'">
                        {% else %}
                          <!-- Group icon (3 nodes with connecting lines) ‚Äî WHITE bg + DARK lines -->
                          <div class="w-10 h-10 rounded-full bg-white text-gray-900 flex items-center justify-center">
                            <svg viewBox="0 0 48 48" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="24" r="5" />
                              <circle cx="36" cy="14" r="5" />
                              <circle cx="36" cy="34" r="5" />
                              <line x1="16.5" y1="22" x2="30.5" y2="16" />
                              <line x1="16.5" y1="26" x2="30.5" y2="32" />
                            </svg>
                          </div>
                        {% endif %}
                        <div class="min-w-0">
                            <div class="text-gray-100 font-semibold truncate">{{ cg.groupchat_name }}</div>
                            <div class="text-gray-400 text-xs truncate">
                                {{ item.preview|default:"Group chat" }}
                            </div>
                        </div>
                        {% if item.unread %}
                        <div class="ml-auto">
                            <span class="inline-flex items-center justify-center min-w-[22px] h-6 px-2 rounded-full bg-indigo-600 text-white text-xs font-semibold">{{ item.unread }}</span>
                        </div>
                        {% endif %}
                        {% if cg.members.count %}
                        <div class="ml-2">
                          <span class="inline-flex items-center justify-center px-2 h-6 rounded-full bg-gray-800 text-gray-300 text-[11px]">
                            {{ cg.members.count }}&nbsp;üë§
                          </span>
                        </div>
                        {% endif %}
                    </a>
                </li>
                {% endwith %}
            {% else %}
                {% with cg=item.group m=item.other %}
                {# Use display_name for filtering and display #}
                <li data-name="{{ m.profile.display_name|default:m.username|lower }}">
                    {% if archived_only %}
                    <a href="{% url 'chatroom' cg.group_name %}?archived=1" class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-800 {% if chat_group and chat_group.group_name == cg.group_name %}bg-gray-800{% endif %}">
                    {% else %}
                    <a href="{% url 'chatroom' cg.group_name %}" class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-gray-800 {% if chat_group and chat_group.group_name == cg.group_name %}bg-gray-800{% endif %}">
                    {% endif %}
                        <img
                            class="w-10 h-10 rounded-full object-cover"
                            src="{% firstof m.profile.avatar default_avatar %}"
                            alt="{{ m.profile.display_name|default:m.username }}"
                            loading="lazy"
                            decoding="async"
                            referrerpolicy="no-referrer"
                            onerror="this.onerror=null;this.src='{{ default_avatar }}'">
                        <div class="min-w-0">
                            <div class="text-gray-100 font-semibold truncate">
                                {{ m.profile.display_name|default:m.username }}
                            </div>
                            <div class="text-gray-400 text-xs truncate">
                                {{ item.preview }}
                            </div>
                        </div>
                        {% if item.unread %}
                        <div class="ml-auto">
                            <span class="inline-flex items-center justify-center min-w-[22px] h-6 px-2 rounded-full bg-indigo-600 text-white text-xs font-semibold">{{ item.unread }}</span>
                        </div>
                        {% endif %}
                        {% if item.is_request %}
                        <div class="ml-2">
                            <span class="inline-flex items-center justify-center px-2 h-6 rounded-full bg-amber-600 text-white text-[10px] font-semibold">Request</span>
                        </div>
                        {% endif %}
                    </a>
                </li>
                {% endwith %}
            {% endif %}
        {% endfor %}
    </ul>

    <script>
        function filterChats(q){
            const query = (q || '').toLowerCase().trim();
            const items = document.querySelectorAll('#chat-list > li[data-name]');
            items.forEach(li => {
                const name = li.getAttribute('data-name') || '';
                li.style.display = name.includes(query) ? '' : 'none';
            });
        }
        function openNewChat(){
            const b = document.getElementById('newchat-backdrop');
            const m = document.getElementById('newchat-modal');
            if(b) b.classList.remove('hidden');
            if(m){
                m.classList.remove('hidden');
                // show direct mode, hide group mode
                document.getElementById('mode-direct')?.classList.remove('hidden');
                document.getElementById('mode-group')?.classList.add('hidden');
                setTimeout(()=>document.getElementById('newchat-input')?.focus(), 0);
            }
        }
        // NEW
        function openNewGroup(){
            const b = document.getElementById('newchat-backdrop');
            const m = document.getElementById('newchat-modal');
            if(b) b.classList.remove('hidden');
            if(m){
                m.classList.remove('hidden');
                // hide direct mode, reveal group mode (HTMX will lazy-load)
                document.getElementById('mode-direct')?.classList.add('hidden');
                const gm = document.getElementById('mode-group');
                gm?.classList.remove('hidden');
            }
        }
    </script>
</aside>
